name: macOS VNC Experience

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Create User & Enable VNC
    - name: Setup User & VNC
      run: |
        echo "Creating new admin user for VNC..."
        sudo sysadminctl -addUser adminvnc -fullName "VNC Admin" -password "Rahasia123!" -admin
        
        echo "Preventing Sleep..."
        sudo systemsetup -setcomputersleep Never
        sudo systemsetup -setdisplaysleep Never
        sudo systemsetup -setharddisksleep Never
        
        echo "Configuring Remote Management (VNC)..."
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -users adminvnc \
          -privs -all \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw Rahasia123! \
          -restart -agent -privs -all

        echo "Forcing Graphical Login..."
        # Mencoba memaksa switch ke user adminvnc
        # Mendapatkan UID adminvnc
        ADMIN_UID=$(dscl . -read /Users/adminvnc UniqueID | awk '{print $2}')
        echo "Switching to User ID: $ADMIN_UID"
        # Gunakan CGSession untuk switch user (Fast User Switching)
        sudo "/System/Library/CoreServices/Menu Extras/User.menu/Contents/Resources/CGSession" -switchToUserID $ADMIN_UID

    # 2. Start SSH Tunnel (Pinggy.io)
    - name: Start Tunnel (Pinggy)
      run: |
        echo "==================================================="
        echo "  STARTING TUNNEL..."
        echo "==================================================="
        
        # Jalankan SSH Tunnel ke Pinggy.io
        # Mode TCP (-R0:localhost:5900)
        # Output log disimpan ke file tunnel.log
        ssh -o StrictHostKeyChecking=no -p 443 -R0:localhost:5900 tcp@a.pinggy.io > tunnel.log 2>&1 &
        
        # Tunggu tunnel connect
        sleep 10
        
        echo "==================================================="
        echo "  CONNECTION INFO"
        echo "==================================================="
        # Pinggy biasanya menampilkan URL di baris pertama log
        cat tunnel.log
        echo ""
        echo "==================================================="
        echo "  COPY ALAMAT DI ATAS (Misal: p1.pinggy.io:12345)"
        echo "  Password VNC: Rahasia123!"
        echo "==================================================="

    # 3. Keep Alive
    - name: Running Session
      run: |
        # Loop 1 jam
        for i in {1..360}; do
          echo "Session active... ($i/360)"
          # Tampilkan log tunnel terus barangkali IP ganti (jarang terjadi)
          tail -n 2 tunnel.log || true
          sleep 10
        done
