name: macOS VNC Experience

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Setup Password & VNC untuk User Default 'runner'
    - name: Setup VNC for 'runner'
      run: |
        echo "Setting password for user 'runner'..."
        # Gunakan path absolut dscl dan invoke dengan sudo
        # Kita abaikan error kalau dia complaint soal password lama, kita paksa reset
        sudo /usr/bin/dscl . -passwd /Users/runner Rahasia123! || echo "DSCL Warning (ignored)"

        echo "Enabling Remote Management..."
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -users runner \
          -privs -all \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw Rahasia123! \
          -restart -agent -privs -all
          
        echo "Check if WindowServer is running..."
        ps aux | grep WindowServer || echo "WindowServer NOT FOUND (This is bad)"

    # 2. Start SSH Tunnel (Pinggy.io)
    - name: Start Tunnel (Pinggy)
      run: |
        echo "Starting tunnel..."
        ssh -o StrictHostKeyChecking=no -p 443 -R0:localhost:5900 tcp@a.pinggy.io > tunnel.log 2>&1 &
        sleep 10
        cat tunnel.log

    # 3. Keep Alive
    - name: Running Session
      run: |
        echo "Session ready. Connect with VNC to localhost:5900 via tunnel."
        echo "User: runner"
        echo "Pass: Rahasia123!"
        for i in {1..360}; do
          tail -n 2 tunnel.log || true
          sleep 10
        done
