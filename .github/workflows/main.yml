name: macOS VNC Experience

on: 
  workflow_dispatch:

jobs:
  debug-mac:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    # 1. Setup User & Auto Login to Bypass Black Screen
    - name: Setup User & VNC
      run: |
        echo "1. Creating new admin user: adminvnc..."
        sudo sysadminctl -addUser adminvnc -fullName "VNC Admin" -password "Rahasia123!" -admin
        
        echo "2. Configuring VNC..."
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -users adminvnc \
          -privs -all \
          -clientopts -setvnclegacy -vnclegacy yes \
          -clientopts -setvncpw -vncpw Rahasia123! \
          -restart -agent -privs -all

        echo "3. ENABLING AUTO LOGIN (Bypass Black Screen)..."
        # Set AutoLoginUser ke adminvnc
        sudo defaults write /Library/Preferences/com.apple.loginwindow autoLoginUser adminvnc
        
        # Generate kcpassword file (XOR obfuscated password)
        # Rahasia123! di-xor dengan key system macOS agar dikenali bootloader
        sudo python3 -c "
        import os
        key = [125, 137, 82, 35, 210, 188, 221, 234, 163, 185, 31]
        password = 'Rahasia123!'
        output = [ord(c) ^ key[i % len(key)] for i, c in enumerate(password)]
        with open('/etc/kcpassword', 'wb') as f:
            f.write(bytes(output))
        os.chmod('/etc/kcpassword', 0o600)
        "
        
        echo "4. Preventing Sleep..."
        sudo systemsetup -setcomputersleep Never
        sudo systemsetup -setdisplaysleep Never || true
        
        echo "5. RESTARTING GUI to trigger Auto Login..."
        sudo killall WindowServer || echo "WindowServer not running"
        sleep 5

    # 2. Start SSH Tunnel (Pinggy.io)
    - name: Start Tunnel (Pinggy)
      run: |
        echo "Starting tunnel..."
        ssh -o StrictHostKeyChecking=no -p 443 -R0:localhost:5900 tcp@a.pinggy.io > tunnel.log 2>&1 &
        sleep 10
        
        echo "==================================================="
        echo "  VNC INFO"
        echo "==================================================="
        cat tunnel.log
        echo "==================================================="
        echo "  JIKA SUKSES, KAMU AKAN LANGSUNG MASUK DESKTOP"
        echo "  User: adminvnc"
        echo "  Pass: Rahasia123!"
        echo "==================================================="

    # 3. Keep Alive
    - name: Running Session
      run: |
        for i in {1..360}; do
          tail -n 2 tunnel.log || true
          sleep 10
        done
